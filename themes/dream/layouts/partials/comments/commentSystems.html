{{ if site.Config.Services.Disqus.Shortname }}
<article>
  {{ partial "comments/disqus.html" (dict "Context" . "Identifier" .RelPermalink) }}
</article>
{{ end }}

{{ if site.Params.giscus.enable }}
<template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1">
  <article>
    <div class="giscus" id="giscus-container"></div>
    <script>
      (function() {
        var LIGHT = 'light';
        var DARK = '{{ site.Params.giscus.darkTheme | default "dark" }}';

        function isDark() {
          var stored = window.localStorage.getItem('hugo-theme-dream-is-dark');
          if (stored === 'y') return true;
          if (stored === 'n') return false;
          return window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        function currentTheme() {
          return isDark() ? DARK : LIGHT;
        }

        // Отправить тему в iframe
        function sendTheme() {
          var frame = document.querySelector('iframe.gsc-frame');
          if (!frame) return;
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: currentTheme() } } },
            'https://giscus.app'
          );
        }

        // 1) Создаём скрипт с правильной начальной темой
        var script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.setAttribute('data-repo', '{{ site.Params.giscus.repo }}');
        script.setAttribute('data-repo-id', '{{ site.Params.giscus.repoId }}');
        script.setAttribute('data-category', '{{ site.Params.giscus.category }}');
        script.setAttribute('data-category-id', '{{ site.Params.giscus.categoryId }}');
        script.setAttribute('data-mapping', '{{ site.Params.giscus.mapping | default "pathname" }}');
        script.setAttribute('data-strict', '{{ if site.Params.giscus.strict }}1{{ else }}0{{ end }}');
        script.setAttribute('data-reactions-enabled', '{{ if site.Params.giscus.reactionsEnabled }}1{{ else }}0{{ end }}');
        script.setAttribute('data-emit-metadata', '0');
        script.setAttribute('data-input-position', '{{ site.Params.giscus.inputPosition | default "top" }}');
        script.setAttribute('data-theme', currentTheme());
        script.setAttribute('data-lang', '{{ site.Params.giscus.lang | default "ru" }}');
        script.setAttribute('data-loading', '{{ site.Params.giscus.loading | default "lazy" }}');
        script.crossOrigin = 'anonymous';
        script.async = true;
        document.getElementById('giscus-container').appendChild(script);

        // 2) Когда iframe загрузится — подтвердить тему
        window.addEventListener('message', function(event) {
          if (event.origin === 'https://giscus.app') {
            sendTheme();
          }
        });

        // 3) Наблюдаем за сменой data-theme на <html>
        //    Dream theme меняет этот атрибут при переключении
        var observer = new MutationObserver(function() {
          sendTheme();
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-theme', 'class']
        });

        // 4) Наблюдаем за localStorage
        //    Если пользователь переключает тему — ловим это
        window.addEventListener('storage', function(event) {
          if (event.key === 'hugo-theme-dream-is-dark') {
            sendTheme();
          }
        });

        // 5) Периодическая проверка (fallback)
        //    На случай если ничего из вышеперечисленного не сработает
        var lastTheme = currentTheme();
        setInterval(function() {
          var now = currentTheme();
          if (now !== lastTheme) {
            lastTheme = now;
            sendTheme();
          }
        }, 500);

      })();
    </script>
  </article>
</template>
{{ end }}

{{ if site.Params.valine }}
<article>
{{ if fileExists "layouts/partials/comments/valine.html" }}
  {{ partialCached "comments/valine.html" . }}
{{ else }}
  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: '{{ site.Params.LEANCLOUD_APP_ID }}',
      appKey: '{{ site.Params.LEANCLOUD_APP_KEY }}'
    })
  </script>
{{ end }}
</article>
{{ end }}

{{ if site.Params.waline }}
<article>
{{ if fileExists "layouts/partials/comments/waline.html" }}
  {{ partialCached "comments/waline.html" . }}
{{ else }}
  <div id="waline"></div>
  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({
      el: '#waline',
      dark: 'html.dark',
      serverURL: {{ site.Params.walineServer }},
    });
  </script>
{{ end }}
</article>
{{ end }}

{{ if site.Params.commentsApp }}
<article class="telegram_comments">
{{ partial "comments/commentsApp.html" . }}
</article>
{{ end }}

{{ if site.Params.telegramComments }}
<article class="telegram_comments">
{{ partial "comments/telegramComments.html" .Params.telegram_post_link }}
</article>
{{ end }}