{{- $navBtnClass := "inline-flex items-center justify-center w-10 h-10 rounded-xl cursor-pointer transition-all duration-200 hover:bg-primary hover:text-primary-content hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 active:scale-95" -}}
{{- $navBtnActiveClass := "bg-primary text-primary-content shadow-md" -}}
{{- $navIconClass := "text-xl transition-colors duration-200" -}}
{{- $navLinkClass := "px-3 py-2 text-sm font-medium rounded-lg cursor-pointer transition-all duration-200 hover:bg-base-200 hover:text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 active:scale-95" -}}
{{- $dropdownMenuClass := "bg-base-100 rounded-xl shadow-xl border border-base-200 dark:border-base-content/10 overflow-hidden" -}}
{{- $menuItemClass := "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-base-200 active:scale-[0.98] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50" -}}
{{- $menuItemActiveClass := "bg-primary/10 text-primary font-semibold" -}}
{{- $menuIconClass := "text-lg flex-shrink-0" -}}

<!-- Обёртка с x-data -->
<div x-data="{ isSticky: false, mobileMenuOpen: false }"
     x-init="
       {{ if site.Params.stickyNav }}
       window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 });
       {{ end }}
       $watch('mobileMenuOpen', value => document.body.classList.toggle('overflow-hidden', value));
     ">

  <!-- NAV BAR -->
  {{ if site.Params.stickyNav }}
  <nav class="sticky top-0 z-30 mt-4 lg:mt-8 py-4 transition-all duration-300 transform-gpu will-change-transform"
       :class="{ 'bg-base-100/80 backdrop-blur-xl backdrop-saturate-150 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.1)] dark:shadow-[0_2px_8px_-2px_rgba(0,0,0,0.3)]': isSticky }">
  {{ else }}
  <nav class="mt-4 lg:mt-8 py-4">
  {{ end }}

    {{ if site.Params.zenMode }}
    <div class="container flex items-center justify-between max-w-[65ch] mx-auto px-4 md:px-0">
    {{ else }}
    <div class="container flex items-center justify-between px-4">
    {{ end }}
    
      <!-- ЛОГОТИП -->
      <section class="flex items-center gap-3">
        <button class="avatar cursor-pointer transition-all duration-200 group" 
                @click="flip = !flip" 
                title="{{ T "flip" }}"
                aria-label="{{ T "flip" }}">
          <div class="w-10 h-10 rounded-full ring-2 ring-transparent group-hover:ring-primary/40 transition-all duration-200">
            <img src="{{ site.Params.avatar | relURL }}" 
                 alt="{{ site.Params.headerTitle }}" 
                 class="rounded-full" 
                 loading="eager" />
          </div>
        </button>

        {{ if or site.Params.headerTitle site.Params.motto }}
        <div class="flex flex-col">
          {{ if site.Params.headerTitle }}
          <a href="{{ .Site.Home.RelPermalink }}" 
             class="text-lg font-semibold hover:text-primary transition-colors duration-200 focus:outline-none focus-visible:text-primary">
            {{ site.Params.headerTitle }}
          </a>
          {{ end }}
          {{ if site.Params.motto }}
          <span class="text-sm text-base-content/60 hidden sm:block">{{- T "motto" -}}</span>
          {{ end }}
        </div>
        {{ end }}
      </section>

      <!-- МОБИЛЬНАЯ КНОПКА -->
      <div class="sm:hidden">
        <button @click="mobileMenuOpen = !mobileMenuOpen" 
                class="{{ $navBtnClass }}"
                :class="{ '{{ $navBtnActiveClass }}': mobileMenuOpen }"
                aria-label="{{ i18n "menu.toggle" | default "Открыть меню" }}"
                :aria-expanded="mobileMenuOpen">
          <ion-icon :name="mobileMenuOpen ? 'close' : 'menu'" class="{{ $navIconClass }}"></ion-icon>
        </button>
      </div>

      <!-- ДЕСКТОПНОЕ МЕНЮ -->
      <section class="hidden sm:flex sm:items-center sm:gap-1 md:gap-2">
        
        {{ with site.GetPage "/about" }}
          {{ $aboutPages := .Resources.ByType "page" }}
          {{ if gt (len $aboutPages) 0 }}
          <button class="{{ $navLinkClass }}"
                  @click="flip = !flip"
                  title="{{ T "about" }}">
            {{- T "about" -}}
          </button>
          {{ end }}
        {{ end }}

        {{ $navItems := slice "search" "rss" "posts" "utilities" "categories" "tags" }}
        {{ if site.Params.reorderNavItems }}
          {{ $navItems = site.Params.reorderNavItems }}
        {{ end }}

        {{ if not site.Params.collapseNavItems }}
          {{ range $navItems }}
            {{ partial "renderNavItem.html" . }}
          {{ end }}

          {{ with site.Params.navItems }}
            {{ partial "navCustomItems.html" (dict "navItems" $navItems "mobile" false) }}
          {{ end }}

        {{ else }}
          {{ $collapseNavItems := site.Params.collapseNavItems }}
          {{ $visibleItems := complement $collapseNavItems $navItems }}
          
          {{ range $visibleItems }}
            {{ partial "renderNavItem.html" . }}
          {{ end }}
        
          <!-- Переключатель языка -->
          <div class="dropdown dropdown-end dropdown-hover">
            <button tabindex="0" 
                    class="{{ $navBtnClass }}" 
                    aria-label="{{ i18n "menu.selectLanguage" | default "Выбрать язык" }}"
                    aria-haspopup="true">
              <ion-icon name="language-outline" class="{{ $navIconClass }}"></ion-icon>
            </button>
            <ul tabindex="0" 
                class="dropdown-content z-[1] min-w-[180px] p-2 mt-2 {{ $dropdownMenuClass }}"
                role="menu">
              {{ range $langCode, $langParams := $.Site.Params.navLang }}
                {{ $isActive := eq $langCode $.Site.Language.Lang }}
                {{ $link := "" }}

                {{/* Ищем перевод текущей страницы */}}
                {{ $translatedPage := false }}
                {{ range $.Page.Translations }}
                  {{ if eq .Lang $langCode }}
                    {{ $translatedPage = . }}
                  {{ end }}
                {{ end }}

                {{ if $translatedPage }}
                  {{ $link = $translatedPage.Permalink }}
                {{ else if eq $langCode "ru" }}
                  {{ $link = "/" }}
                {{ else }}
                  {{ $link = printf "/%s/" $langCode }}
                {{ end }}

                <li role="none">
                  <a href="{{ $link }}" 
                     hreflang="{{ $langCode }}"
                     role="menuitem"
                     class="{{ $menuItemClass }} {{ if $isActive }}{{ $menuItemActiveClass }}{{ end }}"
                     {{ if $isActive }}aria-current="true"{{ end }}>
                    <ion-icon name="{{ $langParams.icon | default "globe-outline" }}" class="{{ $menuIconClass }}"></ion-icon>
                    <span class="flex-1">{{ $langParams.title }}</span>
                    {{ if $isActive }}
                    <ion-icon name="checkmark-circle" class="text-primary text-base"></ion-icon>
                    {{ end }}
                  </a>
                </li>
              {{ end }}
            </ul>
          </div>
            
          <!-- Свёрнутое меню -->
          <div class="dropdown dropdown-end dropdown-hover">
            <button tabindex="0" 
                    class="{{ $navBtnClass }}" 
                    aria-label="{{ i18n "menu.more" | default "Ещё" }}"
                    aria-haspopup="true">
              <ion-icon name="ellipsis-horizontal" class="{{ $navIconClass }}"></ion-icon>
            </button>
            <ul tabindex="0" 
                class="dropdown-content z-[1] w-48 p-2 mt-2 {{ $dropdownMenuClass }}"
                role="menu">
              {{ range $collapseNavItems }}
                {{ partial "renderMobileNavItem.html" (dict "item" . "site" $.Site) }}
              {{ end }}

              {{ with site.Params.navItems }}
                {{ partial "navCustomItems.html" (dict "navItems" $navItems "mobile" true) }}
              {{ end }}
            </ul>
          </div>
        {{ end }}
      </section>
    </div>
  </nav>

  <!-- МОБИЛЬНОЕ МЕНЮ -->
  
  <!-- Overlay -->
  <div x-show="mobileMenuOpen"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       @click="mobileMenuOpen = false"
       class="fixed inset-0 z-40 bg-base-100/80 backdrop-blur-sm sm:hidden"
       style="display: none;"
       aria-hidden="true">
  </div>
  
  <!-- Панель -->
  <div x-show="mobileMenuOpen"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 -translate-y-4 scale-95"
       x-transition:enter-end="opacity-100 translate-y-0 scale-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100 translate-y-0 scale-100"
       x-transition:leave-end="opacity-0 -translate-y-4 scale-95"
       @click.outside="mobileMenuOpen = false"
       @keydown.escape.window="mobileMenuOpen = false"
       class="fixed right-4 top-20 z-50 w-72 max-w-[calc(100vw-2rem)] max-h-[calc(100vh-7rem)] flex flex-col sm:hidden {{ $dropdownMenuClass }}"
       style="display: none;">
    
    <!-- Заголовок -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-base-200 dark:border-base-content/10 flex-shrink-0">
      <span class="font-semibold text-base-content">{{ i18n "menu.menu" | default "Меню" }}</span>
      <button @click="mobileMenuOpen = false" 
              class="inline-flex items-center justify-center w-8 h-8 rounded-lg cursor-pointer transition-all duration-200 hover:bg-base-200 active:scale-95"
              aria-label="{{ i18n "menu.close" | default "Закрыть" }}">
        <ion-icon name="close" class="text-lg"></ion-icon>
      </button>
    </div>
    
    <!-- About -->
    {{ with site.GetPage "/about" }}
      {{ $aboutPages := .Resources.ByType "page" }}
      {{ if gt (len $aboutPages) 0 }}
      <div class="p-3 border-b border-base-200 dark:border-base-content/10 flex-shrink-0">
        <button type="button"
                class="w-full {{ $menuItemClass }}"
                @click="flip = !flip; mobileMenuOpen = false"
                title="{{ T "about" }}"
                aria-label="{{ T "about" }}">
          <ion-icon name="information-circle-outline" class="{{ $menuIconClass }} text-primary"></ion-icon>
          <span class="flex-1 text-left">{{ T "about" }}</span>
          <ion-icon name="chevron-forward-outline" class="text-base-content/40"></ion-icon>
        </button>
      </div>
      {{ end }}
    {{ end }}
    
    <!-- Контент -->
    <div class="p-3 overflow-y-auto flex-1 overscroll-contain">
      {{ partial "navMobileMenu.html" . }}
    </div>
  </div>

</div>