{{/* ===== OG TITLE ===== */}}
{{- $ogTitle := "" -}}
{{- with .Params.seo }}{{ with .title }}{{ $ogTitle = . }}{{ end }}{{ end -}}
{{- if eq $ogTitle "" }}{{ $ogTitle = .Title | default site.Title }}{{ end -}}
<meta property="og:title" content="{{ $ogTitle }}" />


{{/* ===== OG DESCRIPTION ===== */}}
{{- $ogDesc := "" -}}
{{- with .Params.seo }}{{ with .description }}{{ $ogDesc = . }}{{ end }}{{ end -}}
{{- if eq $ogDesc "" }}{{ with .Params.description }}{{ $ogDesc = printf "%s" . }}{{ end }}{{ end -}}
{{- if eq $ogDesc "" -}}
  {{- if .IsPage -}}
    {{- with .Summary }}{{ $ogDesc = printf "%s" . | plainify | htmlUnescape | truncate 200 }}{{ end -}}
  {{- end -}}
{{- end -}}
{{- if eq $ogDesc "" -}}
  {{- if eq .Kind "term" -}}
    {{- if eq .Language.Lang "ru" -}}
      {{- $ogDesc = printf "Все материалы по теме «%s»" .Title -}}
    {{- else -}}
      {{- $ogDesc = printf "All materials about \"%s\"" .Title -}}
    {{- end -}}
  {{- else if eq .Kind "taxonomy" -}}
    {{- if eq .Language.Lang "ru" -}}
      {{- $ogDesc = printf "Список %s на сайте %s" .Title site.Title -}}
    {{- else -}}
      {{- $ogDesc = printf "List of %s on %s" .Title site.Title -}}
    {{- end -}}
  {{- else -}}
    {{- $ogDesc = printf "%s" (.Language.Params.description | default site.Params.description | default "") -}}
  {{- end -}}
{{- end -}}
{{- $ogDesc = printf "%s" ($ogDesc | plainify | htmlUnescape | truncate 200) -}}
<meta property="og:description" content="{{ $ogDesc }}" />


{{/* ===== OG TYPE ===== */}}
{{- $ogType := "website" -}}
{{- if .IsPage -}}
  {{- if in (slice "posts" "post" "blog" "articles") .Section -}}
    {{- $ogType = "article" -}}
  {{- end -}}
{{- end -}}
<meta property="og:type" content="{{ $ogType }}" />
<meta property="og:url" content="{{ .Permalink }}" />
<meta property="og:site_name" content="{{ site.Params.seo.siteName | default site.Title }}" />


{{/* ===== OG LOCALE ===== */}}
{{- $ogLocale := .Language.Params.ogLocale | default "ru_RU" -}}
<meta property="og:locale" content="{{ $ogLocale }}" />
{{- if .IsTranslated -}}
  {{- range .Translations -}}
    {{- $altLocale := .Language.Params.ogLocale | default "en_US" -}}
    <meta property="og:locale:alternate" content="{{ $altLocale }}" />
  {{- end -}}
{{- end -}}


{{/* ===== OG IMAGE ===== */}}
{{- $ogImage := "" -}}
{{- $ogImageWidth := 1200 -}}
{{- $ogImageHeight := 630 -}}

{{/* Хелпер: попытка найти строку как Page Bundle resource */}}
{{/* Если найден — вернёт resized Permalink, иначе absURL */}}

{{/* --- 1. images[] из front matter --- */}}
{{- with .Params.images -}}
  {{- $first := index . 0 -}}
  {{- if $first -}}
    {{- $firstStr := printf "%s" $first -}}
    {{- if strings.HasPrefix $firstStr "http" -}}
      {{- $ogImage = $firstStr -}}
    {{- else -}}
      {{/* Сначала ищем как Page Bundle resource */}}
      {{- $res := $.Resources.GetMatch $firstStr -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $ogImage = $resized.Permalink -}}
        {{- $ogImageWidth = $resized.Width -}}
        {{- $ogImageHeight = $resized.Height -}}
      {{- else -}}
        {{/* Не нашли как ресурс — используем absURL */}}
        {{- $ogImage = $firstStr | absURL -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* --- 2. featured_image --- */}}
{{- if eq $ogImage "" -}}
  {{- with .Params.featured_image -}}
    {{- if strings.HasPrefix . "http" -}}
      {{- $ogImage = . -}}
    {{- else -}}
      {{- $res := $.Resources.GetMatch . -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $ogImage = $resized.Permalink -}}
        {{- $ogImageWidth = $resized.Width -}}
        {{- $ogImageHeight = $resized.Height -}}
      {{- else -}}
        {{- $ogImage = . | absURL -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* --- 3. Cover/cover из front matter --- */}}
{{- if eq $ogImage "" -}}
  {{- $coverParam := "" -}}
  {{- with .Params.Cover }}{{ $coverParam = printf "%s" . }}{{ end -}}
  {{- if eq $coverParam "" -}}
    {{- with .Params.cover -}}
      {{- if reflect.IsMap . -}}
        {{- with .image }}{{ $coverParam = printf "%s" . }}{{ end -}}
      {{- else -}}
        {{- $coverParam = printf "%s" . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if ne $coverParam "" -}}
    {{- $res := .Resources.GetMatch $coverParam -}}
    {{- with $res -}}
      {{- $resized := .Fill "1200x630 Center" -}}
      {{- $ogImage = $resized.Permalink -}}
      {{- $ogImageWidth = $resized.Width -}}
      {{- $ogImageHeight = $resized.Height -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* --- 4. Page Bundle: автопоиск --- */}}
{{- if eq $ogImage "" -}}
  {{- $patterns := slice "Cover.*" "cover.*" "featured.*" "thumbnail.*" "hero.*" "banner.*" -}}
  {{- range $patterns -}}
    {{- if eq $ogImage "" -}}
      {{- $res := $.Resources.GetMatch . -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $ogImage = $resized.Permalink -}}
        {{- $ogImageWidth = $resized.Width -}}
        {{- $ogImageHeight = $resized.Height -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* --- 5. Первое изображение из Page resources --- */}}
{{- if eq $ogImage "" -}}
  {{- if .IsPage -}}
    {{- $firstImg := .Resources.GetMatch "**.{jpg,jpeg,png,webp}" -}}
    {{- with $firstImg -}}
      {{- $resized := .Fill "1200x630 Center" -}}
      {{- $ogImage = $resized.Permalink -}}
      {{- $ogImageWidth = $resized.Width -}}
      {{- $ogImageHeight = $resized.Height -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* --- 6. Автогенерация --- */}}
{{- if eq $ogImage "" -}}
  {{- $generated := partial "seo/og-image-generator.html" . -}}
  {{- if $generated -}}
    {{- $ogImage = $generated -}}
    {{- $ogImageWidth = 1200 -}}
    {{- $ogImageHeight = 630 -}}
  {{- end -}}
{{- end -}}

{{/* --- 7. Дефолтная картинка --- */}}
{{- if eq $ogImage "" -}}
  {{- with site.Params.seo.ogImageDefault -}}
    {{- $ogImage = . | absURL -}}
  {{- end -}}
{{- end -}}

{{- if $ogImage -}}
<meta property="og:image" content="{{ $ogImage }}" />
<meta property="og:image:width" content="{{ $ogImageWidth }}" />
<meta property="og:image:height" content="{{ $ogImageHeight }}" />
<meta property="og:image:alt" content="{{ $ogTitle }}" />
{{- end -}}


{{/* ===== ARTICLE-SPECIFIC ===== */}}
{{- if eq $ogType "article" -}}
  {{- with .Date -}}
  <meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
  {{- end -}}
  {{- with .Lastmod -}}
  <meta property="article:modified_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
  {{- end -}}
  {{- with .Params.author -}}
  <meta property="article:author" content="{{ . }}" />
  {{- end -}}
  {{- range .GetTerms "tags" -}}
  <meta property="article:tag" content="{{ .Title }}" />
  {{- end -}}
  {{- range .GetTerms "categories" -}}
  <meta property="article:section" content="{{ .Title }}" />
  {{- end -}}
{{- end -}}