<meta name="twitter:card" content="summary_large_image" />

{{- with site.Params.seo.twitterSite -}}
  {{- if ne . "" -}}
<meta name="twitter:site" content="{{ . }}" />
  {{- end -}}
{{- end -}}
{{- with site.Params.seo.twitterCreator -}}
  {{- if ne . "" -}}
<meta name="twitter:creator" content="{{ . }}" />
  {{- end -}}
{{- end -}}

{{/* Title */}}
{{- $title := "" -}}
{{- with .Params.seo }}{{ with .title }}{{ $title = . }}{{ end }}{{ end -}}
{{- if eq $title "" }}{{ $title = .Title | default site.Title }}{{ end -}}
{{- $title = $title | truncate 70 -}}
<meta name="twitter:title" content="{{ $title }}" />

{{/* Description */}}
{{- $desc := "" -}}
{{- with .Params.seo }}{{ with .description }}{{ $desc = . }}{{ end }}{{ end -}}
{{- if eq $desc "" }}{{ with .Params.description }}{{ $desc = printf "%s" . }}{{ end }}{{ end -}}
{{- if eq $desc "" -}}
  {{- if .IsPage -}}
    {{- with .Summary }}{{ $desc = printf "%s" . | plainify | htmlUnescape | truncate 200 }}{{ end -}}
  {{- end -}}
{{- end -}}
{{- if eq $desc "" -}}
  {{- if eq .Kind "term" -}}
    {{- if eq .Language.Lang "ru" -}}
      {{- $desc = printf "Все материалы по теме «%s»" .Title -}}
    {{- else -}}
      {{- $desc = printf "All materials about \"%s\"" .Title -}}
    {{- end -}}
  {{- else -}}
    {{- $desc = printf "%s" (.Language.Params.description | default site.Params.description | default "") -}}
  {{- end -}}
{{- end -}}
{{- $desc = printf "%s" ($desc | plainify | htmlUnescape | truncate 200) -}}
<meta name="twitter:description" content="{{ $desc }}" />

{{/* Image — та же логика что и OG */}}
{{- $image := "" -}}

{{/* 1. images[] — ищем как Page Bundle resource */}}
{{- with .Params.images -}}
  {{- $first := index . 0 -}}
  {{- if $first -}}
    {{- $firstStr := printf "%s" $first -}}
    {{- if strings.HasPrefix $firstStr "http" -}}
      {{- $image = $firstStr -}}
    {{- else -}}
      {{- $res := $.Resources.GetMatch $firstStr -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $image = $resized.Permalink -}}
      {{- else -}}
        {{- $image = $firstStr | absURL -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 2. featured_image */}}
{{- if eq $image "" -}}
  {{- with .Params.featured_image -}}
    {{- if strings.HasPrefix . "http" }}{{ $image = . }}{{ else -}}
      {{- $res := $.Resources.GetMatch . -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $image = $resized.Permalink -}}
      {{- else -}}
        {{- $image = . | absURL -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 3. Cover/cover */}}
{{- if eq $image "" -}}
  {{- $coverParam := "" -}}
  {{- with .Params.Cover }}{{ $coverParam = printf "%s" . }}{{ end -}}
  {{- if eq $coverParam "" -}}
    {{- with .Params.cover -}}
      {{- if reflect.IsMap . -}}
        {{- with .image }}{{ $coverParam = printf "%s" . }}{{ end -}}
      {{- else -}}
        {{- $coverParam = printf "%s" . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if ne $coverParam "" -}}
    {{- $res := .Resources.GetMatch $coverParam -}}
    {{- with $res -}}
      {{- $resized := .Fill "1200x630 Center" -}}
      {{- $image = $resized.Permalink -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 4. Page Bundle: автопоиск */}}
{{- if eq $image "" -}}
  {{- $patterns := slice "Cover.*" "cover.*" "featured.*" "thumbnail.*" -}}
  {{- range $patterns -}}
    {{- if eq $image "" -}}
      {{- $res := $.Resources.GetMatch . -}}
      {{- with $res -}}
        {{- $resized := .Fill "1200x630 Center" -}}
        {{- $image = $resized.Permalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 5. Первое изображение */}}
{{- if eq $image "" -}}
  {{- if .IsPage -}}
    {{- $firstImg := .Resources.GetMatch "**.{jpg,jpeg,png,webp}" -}}
    {{- with $firstImg -}}
      {{- $resized := .Fill "1200x630 Center" -}}
      {{- $image = $resized.Permalink -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 6. Автогенерация */}}
{{- if eq $image "" -}}
  {{- $generated := partial "seo/og-image-generator.html" . -}}
  {{- if $generated }}{{ $image = $generated }}{{ end -}}
{{- end -}}

{{/* 7. Дефолт */}}
{{- if eq $image "" -}}
  {{- with site.Params.seo.ogImageDefault -}}
    {{- $image = . | absURL -}}
  {{- end -}}
{{- end -}}

{{- if $image -}}
<meta name="twitter:image" content="{{ $image }}" />
<meta name="twitter:image:alt" content="{{ $title }}" />
{{- end -}}