{{ define "title" }}
{{ .Title }}
{{ end }}

{{ define "main" }}

<div class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-10">

  <!-- Hero -->
  <div class="text-center mb-5 sm:mb-8">
    <div class="inline-flex items-center justify-center w-14 h-14 sm:w-20 sm:h-20 rounded-2xl bg-primary/10 text-primary mb-3 sm:mb-4">
      <span class="text-3xl sm:text-5xl">{{ with .Params.icon }}{{ . }}{{ else }}üìù{{ end }}</span>
    </div>
    <h1 class="text-xl sm:text-3xl lg:text-4xl font-bold mb-2 sm:mb-3">{{ .Title }}</h1>
    <p class="text-sm sm:text-base text-base-content/60 max-w-2xl mx-auto mb-3 sm:mb-4 px-2">{{ .Description }}</p>
    <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2">
      <span class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium bg-success/10 text-success border border-success/20">
        <ion-icon name="eye-outline"></ion-icon> {{ T "markdownEditor.livePreview" }}
      </span>
      <span class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium bg-primary/10 text-primary border border-primary/20">
        <ion-icon name="code-slash-outline"></ion-icon> {{ T "markdownEditor.htmlExport" }}
      </span>
      <span class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium bg-secondary/10 text-secondary border border-secondary/20">
        <ion-icon name="save-outline"></ion-icon> {{ T "markdownEditor.autoSave" }}
      </span>
    </div>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
  <div class="bg-base-100 rounded-xl sm:rounded-2xl border border-base-200 dark:border-base-content/10 shadow-lg sm:shadow-xl overflow-hidden">
    
    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="bg-base-200/50 border-b border-base-200 dark:border-base-content/10 overflow-hidden">
      
      <!-- –ü–µ—Ä–≤—ã–π —Ä—è–¥ -->
      <div class="flex items-center gap-0.5 px-1.5 sm:px-2 pt-1.5 sm:pt-2 pb-0.5 sm:pb-0 flex-wrap">
        
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="bold" title="{{ T "markdownEditor.bold" }}">
          <span class="font-bold text-sm sm:text-base">B</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="italic" title="{{ T "markdownEditor.italic" }}">
          <span class="italic text-sm sm:text-base">I</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="strikethrough" title="{{ T "markdownEditor.strikethrough" }}">
          <span class="line-through text-sm sm:text-base">S</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="code" title="{{ T "markdownEditor.code" }}">
          <ion-icon name="code-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        
        <div class="w-px h-5 bg-base-300 mx-0.5"></div>
        
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm toolbar-btn px-1.5" data-action="h1" title="{{ T "markdownEditor.heading1" }}">
          <span class="text-[11px] sm:text-sm font-bold">H1</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm toolbar-btn px-1.5" data-action="h2" title="{{ T "markdownEditor.heading2" }}">
          <span class="text-[11px] sm:text-sm font-bold">H2</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm toolbar-btn px-1.5" data-action="h3" title="{{ T "markdownEditor.heading3" }}">
          <span class="text-[11px] sm:text-sm font-bold">H3</span>
        </button>
        
        <div class="w-px h-5 bg-base-300 mx-0.5"></div>
        
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="ul" title="{{ T "markdownEditor.bulletList" }}">
          <ion-icon name="list-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="ol" title="{{ T "markdownEditor.numberedList" }}">
          <span class="text-[11px] sm:text-xs font-mono">1.</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="checklist" title="{{ T "markdownEditor.checklist" }}">
          <ion-icon name="checkbox-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        
        <div class="w-px h-5 bg-base-300 mx-0.5"></div>
        
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="link" title="{{ T "markdownEditor.link" }}">
          <ion-icon name="link-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="image" title="{{ T "markdownEditor.image" }}">
          <ion-icon name="image-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn" data-action="codeblock" title="{{ T "markdownEditor.codeBlock" }}">
          <ion-icon name="terminal-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn hidden sm:flex" data-action="table" title="{{ T "markdownEditor.table" }}">
          <ion-icon name="grid-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn hidden sm:flex" data-action="quote" title="{{ T "markdownEditor.quote" }}">
          <ion-icon name="chatbox-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm btn-square toolbar-btn hidden sm:flex" data-action="hr" title="{{ T "markdownEditor.divider" }}">
          <ion-icon name="remove-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
      </div>
      
      <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥ -->
      <div class="flex items-center gap-0.5 px-1.5 sm:px-2 pb-1.5 sm:pb-2 pt-0.5 sm:pt-1">
        
        <div class="flex items-center bg-base-200 rounded-lg p-0.5">
          <button type="button" class="view-btn px-2 py-1 rounded-md text-[10px] sm:text-xs font-medium transition-colors" data-view="editor">
            <ion-icon name="create-outline" class="text-sm sm:text-base"></ion-icon>
            <span class="hidden sm:inline ml-1">{{ T "markdownEditor.editorMode" }}</span>
          </button>
          <button type="button" class="view-btn px-2 py-1 rounded-md text-[10px] sm:text-xs font-medium transition-colors hidden sm:flex" data-view="split">
            <ion-icon name="albums-outline" class="text-sm sm:text-base"></ion-icon>
            <span class="hidden sm:inline ml-1">{{ T "markdownEditor.splitMode" }}</span>
          </button>
          <button type="button" class="view-btn px-2 py-1 rounded-md text-[10px] sm:text-xs font-medium transition-colors" data-view="preview">
            <ion-icon name="eye-outline" class="text-sm sm:text-base"></ion-icon>
            <span class="hidden sm:inline ml-1">{{ T "markdownEditor.previewMode" }}</span>
          </button>
        </div>
        
        <div class="flex-1"></div>
        
        <button type="button" class="btn btn-ghost btn-xs btn-square toolbar-btn sm:hidden" data-action="table" title="{{ T "markdownEditor.table" }}">
          <ion-icon name="grid-outline" class="text-base"></ion-icon>
        </button>
        <button type="button" class="btn btn-ghost btn-xs btn-square toolbar-btn sm:hidden" data-action="quote" title="{{ T "markdownEditor.quote" }}">
          <ion-icon name="chatbox-outline" class="text-base"></ion-icon>
        </button>
        
        <div class="w-px h-5 bg-base-300 mx-0.5"></div>
        
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm gap-1" id="template-btn" title="{{ T "markdownEditor.templates" }}">
          <ion-icon name="document-text-outline" class="text-base sm:text-lg"></ion-icon>
          <span class="hidden md:inline text-xs">{{ T "markdownEditor.templates" }}</span>
        </button>
        <button type="button" class="btn btn-ghost btn-xs sm:btn-sm" id="clear-btn" title="{{ T "markdownEditor.clear" }}">
          <ion-icon name="trash-outline" class="text-base sm:text-lg"></ion-icon>
        </button>
        
        <button type="button" class="btn btn-primary btn-xs sm:btn-sm gap-1" id="export-btn" title="{{ T "markdownEditor.downloadMdTitle" }}">
          <ion-icon name="download-outline" class="text-base sm:text-lg"></ion-icon>
          <span class="hidden xs:inline text-xs sm:text-sm">{{ T "markdownEditor.downloadMd" }}</span>
        </button>
        
      </div>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä + –ü—Ä–µ–≤—å—é -->
    <div id="editor-container" class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-base-200 dark:divide-base-content/10" data-view="split">
      
      <div id="editor-panel" class="flex flex-col">
        <div class="flex items-center justify-between px-3 sm:px-4 py-1.5 sm:py-2 bg-base-200/30 border-b border-base-200 dark:border-base-content/10">
          <div class="flex items-center gap-1.5 sm:gap-2">
            <ion-icon name="create-outline" class="text-base sm:text-lg text-primary"></ion-icon>
            <span class="font-medium text-xs sm:text-sm">{{ T "markdownEditor.markdown" }}</span>
          </div>
          <div class="flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs text-base-content/50">
            <span id="char-count">0 {{ T "markdownEditor.chars" }}</span>
            <span>‚Ä¢</span>
            <span id="word-count">0 {{ T "markdownEditor.words" }}</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span id="line-count" class="hidden sm:inline">0 {{ T "markdownEditor.lines" }}</span>
          </div>
        </div>
        <div class="relative flex-1">
          <textarea 
            id="markdown-input" 
            class="w-full h-[300px] sm:h-[450px] lg:h-[600px] p-3 sm:p-4 font-mono text-xs sm:text-sm bg-transparent border-0 focus:outline-none focus:ring-0 resize-none leading-relaxed"
            placeholder="{{ T "markdownEditor.editorPlaceholder" }}"
            spellcheck="false"
          ></textarea>
        </div>
      </div>

      <div id="preview-panel" class="flex flex-col">
        <div class="flex items-center justify-between px-3 sm:px-4 py-1.5 sm:py-2 bg-base-200/30 border-b border-base-200 dark:border-base-content/10">
          <div class="flex items-center gap-1.5 sm:gap-2">
            <ion-icon name="eye-outline" class="text-base sm:text-lg text-success"></ion-icon>
            <span class="font-medium text-xs sm:text-sm">{{ T "markdownEditor.preview" }}</span>
          </div>
          <button type="button" id="fullscreen-preview" class="btn btn-ghost btn-xs gap-1">
            <ion-icon name="expand-outline" class="text-sm"></ion-icon>
          </button>
        </div>
        <div id="preview-content" class="flex-1 h-[300px] sm:h-[450px] lg:h-[600px] p-3 sm:p-6 overflow-y-auto prose prose-sm max-w-none 
                                          prose-headings:text-base-content prose-p:text-base-content/80
                                          prose-a:text-primary prose-strong:text-base-content
                                          prose-code:text-primary prose-code:bg-base-200 prose-code:px-1 prose-code:py-0.5 prose-code:rounded
                                          prose-pre:bg-base-200 prose-pre:text-base-content
                                          prose-blockquote:border-primary prose-blockquote:text-base-content/70
                                          prose-li:text-base-content/80 sm:prose">
          <p class="text-base-content/40 italic text-sm">{{ T "markdownEditor.previewPlaceholder" }}</p>
        </div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
    <div class="flex items-center justify-between px-3 sm:px-4 py-1.5 sm:py-2 bg-base-200/30 border-t border-base-200 dark:border-base-content/10 text-[10px] sm:text-xs text-base-content/50">
      <span id="save-status" class="flex items-center gap-1">
        <ion-icon name="checkmark-circle" class="text-success"></ion-icon> {{ T "markdownEditor.saved" }}
      </span>
      <div class="flex items-center gap-2 sm:gap-4">
        <span class="hidden sm:inline">{{ T "markdownEditor.markdownToHtml" }}</span>
        <span class="hidden sm:flex items-center gap-1"><kbd class="kbd kbd-xs">Ctrl+S</kbd> {{ T "markdownEditor.save" }}</span>
      </div>
    </div>
  </div>

  <!-- –®–ø–∞—Ä–≥–∞–ª–∫–∞ -->
  <div class="mt-4 sm:mt-6 bg-base-100 rounded-xl sm:rounded-2xl border border-base-200 dark:border-base-content/10 overflow-hidden">
    <details class="group">
      <summary class="flex items-center justify-between p-3 sm:p-4 cursor-pointer select-none hover:bg-base-200/50 transition-colors">
        <div class="flex items-center gap-2.5 sm:gap-3">
          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-info/10 flex items-center justify-center shrink-0">
            <ion-icon name="help-circle-outline" class="text-lg sm:text-xl text-info"></ion-icon>
          </div>
          <div>
            <h3 class="font-semibold text-sm sm:text-base">{{ T "markdownEditor.cheatsheetTitle" }}</h3>
            <p class="text-[10px] sm:text-xs text-base-content/60">{{ T "markdownEditor.cheatsheetSubtitle" }}</p>
          </div>
        </div>
        <ion-icon name="chevron-down" class="text-lg sm:text-xl text-base-content/40 group-open:rotate-180 transition-transform shrink-0"></ion-icon>
      </summary>
      <div class="px-3 pb-3 sm:px-4 sm:pb-4">
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4">
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatText" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code>{{ T "markdownEditor.cheatBold" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatItalic" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatStrike" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatCode" }}</code></div>
            </div>
          </div>
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatHeadings" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code># H1</code></div>
              <div><code>## H2</code></div>
              <div><code>### H3</code></div>
            </div>
          </div>
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatLists" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code>{{ T "markdownEditor.cheatListItem" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatOrderedItem" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatTaskItem" }}</code></div>
            </div>
          </div>
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatLinks" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code>{{ T "markdownEditor.cheatLinkSyntax" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatImageSyntax" }}</code></div>
            </div>
          </div>
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatCodeSection" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code>{{ T "markdownEditor.cheatInlineCode" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatCodeBlock" }}</code></div>
            </div>
          </div>
          <div class="p-2.5 sm:p-4 rounded-lg bg-base-200/50">
            <h4 class="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-3">{{ T "markdownEditor.cheatOther" }}</h4>
            <div class="space-y-1 text-[10px] sm:text-sm font-mono">
              <div><code>{{ T "markdownEditor.cheatQuote" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatHr" }}</code></div>
              <div><code>{{ T "markdownEditor.cheatTable" }}</code></div>
            </div>
          </div>
        </div>
      </div>
    </details>
  </div>

  <!-- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ -->
  <div class="hidden sm:block mt-4 p-3 sm:p-4 rounded-xl sm:rounded-2xl bg-base-200/30 border border-base-200 dark:border-base-content/10">
    <div class="flex items-center gap-2 mb-2">
      <ion-icon name="keypad-outline" class="text-base text-base-content/60"></ion-icon>
      <span class="text-xs font-medium text-base-content/60">{{ T "markdownEditor.hotkeys" }}</span>
    </div>
    <div class="flex flex-wrap gap-3 sm:gap-4 text-xs text-base-content/60">
      <div class="flex items-center gap-1"><kbd class="kbd kbd-xs">Ctrl+B</kbd> {{ T "markdownEditor.hotkeyBold" }}</div>
      <div class="flex items-center gap-1"><kbd class="kbd kbd-xs">Ctrl+I</kbd> {{ T "markdownEditor.hotkeyItalic" }}</div>
      <div class="flex items-center gap-1"><kbd class="kbd kbd-xs">Ctrl+K</kbd> {{ T "markdownEditor.hotkeyLink" }}</div>
      <div class="flex items-center gap-1"><kbd class="kbd kbd-xs">Ctrl+S</kbd> {{ T "markdownEditor.hotkeySave" }}</div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ -->
<dialog id="templates-modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl sm:rounded-2xl">
    <h3 class="font-bold text-base sm:text-lg mb-3 sm:mb-4">{{ T "markdownEditor.chooseTemplate" }}</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2.5 sm:gap-3" id="templates-list"></div>
    <div class="modal-action">
      <form method="dialog"><button class="btn btn-sm sm:btn-md">{{ T "markdownEditor.cancel" }}</button></form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é -->
<dialog id="fullscreen-modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-4xl h-[85vh] sm:h-[90vh] sm:rounded-2xl p-3 sm:p-6">
    <div class="flex items-center justify-between mb-3 sm:mb-4">
      <h3 class="font-bold text-base sm:text-lg">{{ T "markdownEditor.fullscreenPreview" }}</h3>
      <form method="dialog">
        <button class="btn btn-ghost btn-sm btn-circle"><ion-icon name="close-outline" class="text-xl"></ion-icon></button>
      </form>
    </div>
    <div id="fullscreen-content" class="prose prose-sm sm:prose max-w-none overflow-y-auto h-[calc(100%-3rem)] sm:h-[calc(100%-4rem)]"></div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- –°–∫—Ä—ã—Ç–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
<a id="download-link" style="display:none;"></a>

<script>
(function() {
  'use strict';

  var i18n = {
    saved: "{{ T "markdownEditor.saved" }}",
    saving: "{{ T "markdownEditor.saving" }}",
    chars: "{{ T "markdownEditor.chars" }}",
    words: "{{ T "markdownEditor.words" }}",
    lines: "{{ T "markdownEditor.lines" }}",
    previewPlaceholder: "{{ T "markdownEditor.previewPlaceholder" }}",
    clearConfirm: "{{ T "markdownEditor.clearConfirm" }}",
    emptyEditor: "{{ T "markdownEditor.emptyEditor" }}",
    // Toolbar placeholders
    phBold: "{{ T "markdownEditor.phBold" }}",
    phItalic: "{{ T "markdownEditor.phItalic" }}",
    phStrike: "{{ T "markdownEditor.phStrike" }}",
    phCode: "{{ T "markdownEditor.phCode" }}",
    phLinkText: "{{ T "markdownEditor.phLinkText" }}",
    phAlt: "{{ T "markdownEditor.phAlt" }}",
    phTableHeader1: "{{ T "markdownEditor.phTableHeader1" }}",
    phTableHeader2: "{{ T "markdownEditor.phTableHeader2" }}",
    // Template names
    tplReadmeName: "{{ T "markdownEditor.tplReadmeName" }}",
    tplArticleName: "{{ T "markdownEditor.tplArticleName" }}",
    tplChecklistName: "{{ T "markdownEditor.tplChecklistName" }}",
    tplNotesName: "{{ T "markdownEditor.tplNotesName" }}",
    // Template content
    tplReadmeContent: {{ T "markdownEditor.tplReadmeContent" | jsonify }},
    tplArticleContent: {{ T "markdownEditor.tplArticleContent" | jsonify }},
    tplChecklistContent: {{ T "markdownEditor.tplChecklistContent" | jsonify }},
    tplNotesContent: {{ T "markdownEditor.tplNotesContent" | jsonify }}
  };
  
  var input = document.getElementById('markdown-input');
  var preview = document.getElementById('preview-content');
  var container = document.getElementById('editor-container');
  var editorPanel = document.getElementById('editor-panel');
  var previewPanel = document.getElementById('preview-panel');
  var charEl = document.getElementById('char-count');
  var wordEl = document.getElementById('word-count');
  var lineEl = document.getElementById('line-count');
  var statusEl = document.getElementById('save-status');
  var downloadLink = document.getElementById('download-link');
  
  var STORAGE_KEY = 'md-editor-v2';

  // ===== MARKDOWN PARSER =====
  function parse(md) {
    var h = md;
    h = h.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    h = h.replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
      return '<pre><code class="language-' + lang + '">' + code.trim() + '</code></pre>';
    });
    h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    h = h.replace(/^###### (.+)$/gm, '<h6>$1</h6>');
    h = h.replace(/^##### (.+)$/gm, '<h5>$1</h5>');
    h = h.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
    h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    h = h.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    h = h.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    
    h = h.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
    h = h.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
    h = h.replace(/__(.+?)__/g, '<strong>$1</strong>');
    h = h.replace(/_(.+?)_/g, '<em>$1</em>');
    h = h.replace(/~~(.+?)~~/g, '<del>$1</del>');
    
    h = h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />');
    h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    h = h.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
    h = h.replace(/<\/blockquote>\n<blockquote>/g, '\n');
    
    h = h.replace(/^(-{3,}|\*{3,}|_{3,})$/gm, '<hr />');
    
    h = h.replace(/^- \[x\] (.+)$/gm, '<li><input type="checkbox" checked disabled /> $1</li>');
    h = h.replace(/^- \[ \] (.+)$/gm, '<li><input type="checkbox" disabled /> $1</li>');
    h = h.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
    h = h.replace(/(<li>.*<\/li>\n?)+/g, function(m) { return '<ul>' + m + '</ul>'; });
    
    h = h.replace(/^\d+\. (.+)$/gm, '<oli>$1</oli>');
    h = h.replace(/(<oli>.*<\/oli>\n?)+/g, function(m) {
      return '<ol>' + m.replace(/<\/?oli>/g, function(t) { return t === '<oli>' ? '<li>' : '</li>'; }) + '</ol>';
    });
    
    h = h.replace(/^\|(.+)\|$/gm, function(m, content) {
      var cells = content.split('|').map(function(c) { return c.trim(); });
      if (cells.every(function(c) { return /^[-:]+$/.test(c); })) return '';
      return '<tr>' + cells.map(function(c) { return '<td>' + c + '</td>'; }).join('') + '</tr>';
    });
    h = h.replace(/(<tr>.*<\/tr>\n?)+/g, function(m) { return '<table class="table table-zebra">' + m + '</table>'; });
    
    h = h.split('\n\n').map(function(block) {
      block = block.trim();
      if (!block) return '';
      if (block.charAt(0) === '<') return block;
      return '<p>' + block.replace(/\n/g, '<br />') + '</p>';
    }).join('\n');
    
    return h;
  }

  // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï =====
  function refresh() {
    var md = input.value;
    preview.innerHTML = md ? parse(md) : '<p class="text-base-content/40 italic text-sm">' + i18n.previewPlaceholder + '</p>';
    charEl.textContent = md.length + ' ' + i18n.chars;
    wordEl.textContent = (md.match(/\S+/g) || []).length + ' ' + i18n.words;
    lineEl.textContent = md.split('\n').length + ' ' + i18n.lines;
  }

  // ===== STORAGE =====
  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, input.value);
      statusEl.innerHTML = '<ion-icon name="checkmark-circle" class="text-success"></ion-icon> ' + i18n.saved;
    } catch(e) {}
  }
  
  function load() {
    try {
      var s = localStorage.getItem(STORAGE_KEY);
      if (s) { input.value = s; refresh(); }
    } catch(e) {}
  }

  // ===== TOOLBAR INSERT =====
  function wrap(before, after, ph) {
    var s = input.selectionStart;
    var e = input.selectionEnd;
    var sel = input.value.substring(s, e) || ph || '';
    var t = input.value;
    input.value = t.substring(0, s) + before + sel + after + t.substring(e);
    input.focus();
    input.setSelectionRange(s + before.length, s + before.length + sel.length);
    refresh();
    save();
  }
  
  function linePrefix(prefix) {
    var s = input.selectionStart;
    var t = input.value;
    var ls = t.lastIndexOf('\n', s - 1) + 1;
    input.value = t.substring(0, ls) + prefix + t.substring(ls);
    input.focus();
    input.setSelectionRange(s + prefix.length, s + prefix.length);
    refresh();
    save();
  }

  // ===== TOOLBAR INSERT =====
  var actions = {
    bold: function() { wrap('**', '**', i18n.phBold); },
    italic: function() { wrap('*', '*', i18n.phItalic); },
    strikethrough: function() { wrap('~~', '~~', i18n.phStrike); },
    code: function() { wrap('`', '`', i18n.phCode); },
    h1: function() { linePrefix('# '); },
    h2: function() { linePrefix('## '); },
    h3: function() { linePrefix('### '); },
    ul: function() { linePrefix('- '); },
    ol: function() { linePrefix('1. '); },
    checklist: function() { linePrefix('- [ ] '); },
    link: function() { wrap('[', '](https://)', i18n.phLinkText); },
    image: function() { wrap('![', '](https://)', i18n.phAlt); },
    quote: function() { linePrefix('> '); },
    hr: function() { wrap('\n---\n', '', ''); },
    codeblock: function() { wrap('\n```\n', '\n```\n', i18n.phCode); },
    table: function() { wrap('\n| ' + i18n.phTableHeader1 + ' | ' + i18n.phTableHeader2 + ' |\n|---|---|\n| A | B |\n', '', ''); }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ toolbar
  document.querySelectorAll('.toolbar-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      var a = btn.getAttribute('data-action');
      if (actions[a]) actions[a]();
    });
  });

  // ===== VIEW MODES =====
  document.querySelectorAll('.view-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      var view = btn.getAttribute('data-view');
      
      document.querySelectorAll('.view-btn').forEach(function(b) {
        b.classList.remove('bg-base-100', 'shadow-sm', 'text-base-content');
        b.classList.add('text-base-content/60');
      });
      btn.classList.add('bg-base-100', 'shadow-sm', 'text-base-content');
      btn.classList.remove('text-base-content/60');
      
      if (view === 'editor') {
        editorPanel.classList.remove('hidden');
        previewPanel.classList.add('hidden');
        container.classList.remove('lg:grid-cols-2');
      } else if (view === 'preview') {
        editorPanel.classList.add('hidden');
        previewPanel.classList.remove('hidden');
        container.classList.remove('lg:grid-cols-2');
      } else {
        editorPanel.classList.remove('hidden');
        previewPanel.classList.remove('hidden');
        container.classList.add('lg:grid-cols-2');
      }
    });
  });

  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º split –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  var defaultView = document.querySelector('.view-btn[data-view="split"]') || document.querySelector('.view-btn[data-view="editor"]');
  if (defaultView) {
    defaultView.classList.add('bg-base-100', 'shadow-sm', 'text-base-content');
    defaultView.classList.remove('text-base-content/60');
  }

  // ===== –≠–ö–°–ü–û–†–¢ ‚Äî –°–ö–ê–ß–ò–í–ê–ù–ò–ï .md –§–ê–ô–õ–ê =====
  function getFileName() {
    var now = new Date();
    var date = now.getFullYear() + '-' +
      String(now.getMonth() + 1).padStart(2, '0') + '-' +
      String(now.getDate()).padStart(2, '0');
    
    var firstLine = input.value.trim().split('\n')[0] || '';
    var name = firstLine.replace(/^#+\s*/, '').replace(/[^\w\s–∞-—è—ë–ê-–Ø–Å-]/gi, '').trim();
    if (!name) name = 'document';
    name = name.replace(/\s+/g, '-').substring(0, 50);
    
    return date + '_' + name + '.md';
  }

  document.getElementById('export-btn').addEventListener('click', function(e) {
    e.preventDefault();
    
    var content = input.value;
    if (!content.trim()) {
      alert(i18n.emptyEditor);
      return;
    }
    
    var blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    
    downloadLink.href = url;
    downloadLink.download = getFileName();
    downloadLink.click();
    
    setTimeout(function() {
      URL.revokeObjectURL(url);
    }, 1000);
  });

  // ===== TEMPLATES =====
  var templates = {
    readme: { name: i18n.tplReadmeName, icon: 'document-text-outline', content: i18n.tplReadmeContent },
    article: { name: i18n.tplArticleName, icon: 'newspaper-outline', content: i18n.tplArticleContent },
    checklist: { name: i18n.tplChecklistName, icon: 'checkbox-outline', content: i18n.tplChecklistContent },
    notes: { name: i18n.tplNotesName, icon: 'create-outline', content: i18n.tplNotesContent }
  };
  
  document.getElementById('template-btn').addEventListener('click', function() {
    var list = document.getElementById('templates-list');
    var html = '';
    var keys = Object.keys(templates);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var t = templates[k];
      html += '<button type="button" class="btn btn-ghost justify-start gap-3 h-auto py-4 tpl-item" data-tpl="' + k + '">';
      html += '<ion-icon name="' + t.icon + '" class="text-2xl text-primary"></ion-icon>';
      html += '<span class="font-medium">' + t.name + '</span></button>';
    }
    list.innerHTML = html;
    
    list.querySelectorAll('.tpl-item').forEach(function(btn) {
      btn.addEventListener('click', function() {
        input.value = templates[btn.getAttribute('data-tpl')].content;
        refresh();
        save();
        document.getElementById('templates-modal').close();
      });
    });
    
    document.getElementById('templates-modal').showModal();
  });

  // ===== CLEAR =====
  document.getElementById('clear-btn').addEventListener('click', function() {
    if (input.value.trim() && confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä?')) {
      input.value = '';
      refresh();
      save();
    }
  });

  // ===== FULLSCREEN PREVIEW =====
  document.getElementById('fullscreen-preview').addEventListener('click', function() {
    document.getElementById('fullscreen-content').innerHTML = preview.innerHTML;
    document.getElementById('fullscreen-modal').showModal();
  });

  // ===== HOTKEYS =====
  input.addEventListener('keydown', function(e) {
    var mod = navigator.platform.indexOf('Mac') > -1 ? e.metaKey : e.ctrlKey;
    if (mod) {
      var k = e.key.toLowerCase();
      if (k === 'b') { e.preventDefault(); actions.bold(); }
      if (k === 'i') { e.preventDefault(); actions.italic(); }
      if (k === 'k') { e.preventDefault(); actions.link(); }
      if (k === 's') { e.preventDefault(); save(); }
    }
    if (e.key === 'Tab') { e.preventDefault(); wrap('  ', '', ''); }
  });

  // ===== INIT =====
  input.addEventListener('input', function() {
    refresh();
    statusEl.innerHTML = '<ion-icon name="sync-outline" class="animate-spin"></ion-icon> ...';
    clearTimeout(input._st);
    input._st = setTimeout(save, 800);
  });
  
  load();
  refresh();
  
})();
</script>
{{ end }}